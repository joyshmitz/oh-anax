# Edge node agent-install

## Overview

Цей скрипт:

* Перевіряє передумови та інформацію про конфігурацію
* встановлює пакунки агентів, які підходять для периферійного вузла
* За бажанням реєструє периферійний вузол із заданим шаблоном або політикою вузла
* За бажанням очікує на початок виконання вказаного сервісу на периферійному вузлі

## Вимоги

Підтримувані на даний момент ОС та архітектури:

* Пристрій
  * Ubuntu bionic, xenial, focal
    * arm64, amd64
  * Raspbian buster, stretch
    * armhf
  * Debian buster, stretch
    * amd64
  * RHEL 7.6, 7.9, 8, 8.1, 8.2, 8.3, 8.4, 8.5, 8.6
    * amd64, ppc64le, aarch64, riscv64
  * CentOS 7.6, 7.9, 8, 8.1, 8.2, 8.3, 8.4, 8.5
    * amd64, ppc64le, aarch64, riscv64
  * Fedora 32, 36
    * amd64, ppc64le, aarch64, riscv64
  * macOS
    * amd64
* Cluster
  * OCP 4.5, 4.6, 4.7, 4.8
    * amd64, ppc64le
  * Microk8s
    * amd64, ppc64le
  * k3s
    * amd64, ppc64le

## Опис

У цьому описі описано, як працює `agent-install.sh` для власного встановлення на пристроях Linux, а також для контейнерного встановлення на Linux і MacOS. Цей опис не охоплює відмінності у встановленні кластерних агентів.

Для правильної роботи цього скрипта потрібно запустити його з параметром `udo -s`.

Спочатку скрипт витягне файли із заданого tar-файлу, вказаного за допомогою `-z`. Цей скрипт перевіряє всі свої аргументи і змінні. Якщо потрібну змінну оточення не визначено, скрипт використає значення з конфігураційного файлу, якщо такий є. Якщо необхідну інформацію не вказано, скрипт завершить роботу. Якщо відсутня необов'язкова інформація, скрипт продовжить роботу з попередженням.

Потім скрипт визначає активну операційну систему, версію та архітектуру і починає процес встановлення агента. Якщо існує файл зіставлення ідентифікаторів вузлів, скрипт перевірить ідентифікатор вузла, використовуючи його ім'я хоста, а потім ip-адресу, якщо ім'я хоста не буде знайдено. Якщо файл зіставлення ідентифікатора вузла знайдено, вважається, що це пакетне встановлення, і користувачеві не буде надано жодних підказок.

Для контейнерного встановлення у Linux скрипт перевіряє наявність Docker або Podman і jq. Для Ubuntu, Debian і Raspian скрипт встановить їх, якщо вони відсутні. При встановленні RHEL, CentOS і Fedora користувач повинен встановити їх перед запуском цього скрипта. Для MacOS, яка завжди встановлюється у контейнері Docker, скрипт перевіряє наявність Docker, jq і socat, і завершує роботу, якщо їх не встановлено.

Перед початком встановлення `agent-install.sh` перевіряє, чи вузол вже зареєстровано. У цьому випадку він запитує, чи хоче користувач перезаписати поточну конфігурацію вузла. Якщо відповідь "так", вузол буде скасовано, а пакунки і конфігурацію буде оновлено. Якщо це пакетне встановлення, або користувач відповів "ні" на запит, скрипт встановить систему без перезапису існуючої конфігурації вузла.

Далі скрипт завантажить сертифікат, який за замовчуванням називається `agent-install.crt`, з CSS на вузлі керування, якщо він ще не присутній у каталозі встановлення. Потім скрипт оновить значення за замовчуванням горизонту в `/etc/default/horizon` і встановить порт для запуску anax, якщо агент встановлюється за замовчуванням. Для контейнерного встановлення порт anax завжди відкрито на порту контейнера 8081.

Останнім кроком перед встановленням є завантаження необхідних пакунків, якщо їх ще немає у каталозі встановлення. Пакунки **horizon** та **horizon-cli** завантажуються за замовчуванням, за винятком контейнерного встановлення у Linux, встановлення у MacOS або якщо користувач вказав прапорець `-C`. У цих випадках буде встановлено лише пакунок **horizon-cli**.

Скрипт завантажить пакунок(и) з місця, вказаного за допомогою `-i`. Якщо було вказано `'css:'` (з додаванням або без додавання шляху), він завантажить пакунок(и) з CSS на хабі керування. Якщо було вказано `https://github.com/open-horizon/anax/releases/<release>`, він отримає вказані версії пакунків зі сховища релізів anax. Якщо було вказано репозиторій APT, скрипт додасть ключ до репозиторію APT і встановить пакунок(и) за допомогою репозиторію APT. (Зауваження: встановлення за допомогою APT сумісне лише зі збірками Ubuntu, Debian і Raspbian Linux).

У Ubuntu, Debian і Raspbian Linux, якщо користувач вказав репозиторій APT, пакунки вже буде встановлено за допомогою репозиторію APT. У всіх інших системах Linux пакунки **horizon** та/або **horizon-cli** буде встановлено за допомогою завантажених пакунків, отриманих з релізів anax або CSS.

Якщо пакунки, що встановлюються, є старішими за ті, що встановлюються зараз, скрипт запитає користувача, чи бажає він продовжити встановлення. Якщо це пакетне встановлення, старішу версію не буде встановлено, якщо не було вказано `-f`. Якщо версія пакунка дорівнює встановленій, скрипт покаже попередження і завершить роботу.

Під час встановлення контейнера у Linux та MacOS змінна `HORIZON_URL` встановлюється у значення <http://localhost:8081>, щоб команда `hzn` CLI могла звернутися до агента, запущеного у контейнері. Після цього запускається контейнер і скрипт чекає на запуск агента. У всіх інших системах Linux скрипт перевіряє, чи було встановлено нові пакунки, або чи було змінено горизонт за замовчуванням у `/etc/default/horizon`. Якщо це так, агент перезапускається перед реєстрацією.

Після завершення встановлення і налаштування у Exchange буде створено вузол, який буде зареєстровано у шаблоні або політиці, якщо їх буде вказано. Якщо вказано -w \<ім'я служби\>, скрипт чекатиме, доки вказана служба не почне виконуватися на вузлі.

## Використання

Приклад: sudo -s ./agent-install.sh -i . -u $HZN_EXCHANGE_USER_AUTH -p IBM/pattern-ibm.helloworld -w ibm.helloworld -o $HZN_ORG_ID -z $AGENT_TAR_FILE`

### Файл конфігурації

За замовчуванням програма шукатиме файл конфігурації з назвою `agent-install.cfg` у тому ж каталозі. Конфігураційний файл повинен містити, як мінімум:

```bash
HZN_EXCHANGE_URL=https://<management-hub-url>:3090/edge-exchange/v1/
HZN_FSS_CSSURL=https://<management-hub-url>:9443/edge-css/
HZN_AGBOT_URL=https://<management-hub-url>:3111/edge-agbot/
HZN_SDO_SVC_URL=https://<management-hub-url>:9008/edge-sdo-ocs/api
```

У конфігураційному файлі також можуть бути встановлені наступні змінні:
`HZN_DEVICE_ID`, `HZN_NODE_ID`, `HZN_MGMT_HUB_CERT_PATH` і `HZN_AGENT_PORT`.
Для кластерного встановлення, конфігураційний файл також може встановлювати:
`ПРОСТІР_ІМЕН_АГЕНТІВ`.

### Файл сертифікату

За замовчуванням буде використано файл сертифіката з назвою `agent-install.crt` у тому ж каталозі, якщо він існує. Якщо пакунки завантажуються з CSS, сертифікат буде витягнуто із завантажених файлів. Це місце можна замінити у файлі конфігурації.

### Змінні оточення

Змінні оточення з тими ж іменами, що і змінні у файлі конфігурації вище, можуть бути використані для заміни значень файлу конфігурації. Змінні, встановлені за допомогою прапорів, мають найвищий пріоритет.

### Прапори командного рядка

Прапори командного рядка перевизначають відповідні змінні оточення або змінні конфігураційного файлу:

`-c <шлях>` - шлях до файлу agent-install.crt з вашого центру керування. За замовчуванням: `./agent-install.crt`.

`-k <шлях>` - шлях до файлу agent-install.cfg, який містить налаштування горизонту за замовчуванням. За замовчуванням: `./agent-install.cfg`

`-i <шлях>` - шлях до пакунків. Вкажіть `css:` для отримання пакунків з хабу управління MMS. Вкажіть `https://github.com/open-horizon/anax/releases`, щоб отримати найсвіжіші пакунки з відкритого репозиторію open horizon anax github. За замовчуванням: поточний каталог

`-z <ім'я>` - вказує ім'я інсталяційного tar-файлу вашого агента. За замовчуванням: ./agent-install-files.tar.gz

`-j <шлях>` - шлях до файлу з відкритим ключем для репозиторію APT, вказаного за допомогою `-i`.

`-t <branch>` - гілка для використання в репозиторії APT, вказана за допомогою `-i`

`-O <exchange org>` - Ідентифікатор організації обміну

`-u <exchange credentials>` - вказує ваші облікові дані користувача біржі у вигляді `iamapikey:<api-key>` або `username:password`

`-d <node id>` - ідентифікатор вузла для реєстрації. Тільки для індивідуального, а не пакетного встановлення.

`-p <шаблон>` - назва шаблону для реєстрації цього вузла. За замовчуванням: реєструє вузол з політикою

`-n <шлях>` - шлях до файлу політики вузла

`-w <ім'я сервісу>` - змушує скрипт чекати кількість секунд, вказану в `-T` (за замовчуванням: 60), поки не буде досягнуто домовленостей і не буде розгорнуто сервіс. Якщо використовується шаблон, це значення може бути '*'

`-T <тайм-аут>` - кількість секунд очікування скриптом сервісів, вказана в `-w`.

`-o <ім'я орг>` - вказує орг сервісу, який ви вказали за допомогою прапорця -w. Якщо його не встановлено, за замовчуванням буде використано орг вашого периферійного пристрою.

`-s` - пропустити реєстрацію вузла

`-D <тип>` - тип вузла агента, що встановлюється: пристрій, кластер. За замовчуванням: пристрій

`-U <url>` - внутрішня адреса для реєстру кластера. Якщо не вказано, цей скрипт автоматично визначить значення, якщо це невеликий кластер з одним вузлом (наприклад, k3s або microk8s). Для OCP використовуйте: image-registry.openshift-image-registry.svc:5000

`-l` - рівень багатослівності логування (0: мовчазний, 1: критичний, 2: помилка, 3: попередження, 4: інформація, 5: налагодження), за замовчуванням (3: попередження)

`-f` - використовуйте при пакетному встановленні, щоб дозволити скрипту встановити старішу версію, ніж встановлена в даний момент

`-b` - пропустити будь-які запити на введення даних. Поведінка за замовчуванням для пакетного встановлення.

`-C` - Встановити лише пакунок horizon-cli, а не повний агент

`--container` - Встановити агента у контейнер

`--namespace` - Простір імен, до якого буде встановлено кластерний агент. За замовчуванням використовується 'openhorizon-agent'

`--namespace-scoped` - Кластерний агент матиме лише область дії простору імен. Значення за замовчуванням 'false'

### anax-in-container

Для встановлення більше ніж 1 агента у контейнері використовується команда horizon-container (яка входить до складу пакунка horizon-cli). Інструкції можна знайти нижче:

[anax-in-container install instructions](https://github.com/open-horizon/anax/blob/master/anax-in-container/README.md)

## Дерево пакунків

Скрипт спирається на дерево інсталяційних пакунків з наступною структурою каталогів:

```text
.
└── horizon-edge-packages
    ├── agent-install.cfg
    ├── agent-install.crt
    ├── agent-install.sh
    ├── agent-uninstall.sh
    ├── amd64_anax.tar.gz
    ├── amd64_anax_k8s.tar.gz
    ├── deployment-template.yml
    ├── amd64_auto-upgrade-cronjob_k8s.tar.gz
    ├── auto-upgrade-cronjob-template.yml
    ├── horizon-2.30.0.x86_64.rpm
    ├── horizon-cli-2.30.0.pkg
    ├── horizon-cli-2.30.0.x86_64.rpm
    ├── horizon-cli.crt
    ├── horizon-cli_2.30.0_arm64.deb
    ├── horizon-cli_2.30.0_amd64.deb
    ├── horizon-cli_2.30.0_armhf.deb
    ├── horizon_2.30.0_arm64.deb
    ├── horizon_2.30.0_amd64.deb
    ├── horizon_2.30.0_armhf.deb
    └── persistentClaim-template.yml
```
